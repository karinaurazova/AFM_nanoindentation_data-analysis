# Анализ данных наноиндентации AFM

Полный скрипт для обработки и анализа кривых "сила-расстояние", полученных методом атомно-силовой микроскопии (AFM) при наноиндентации биологических образцов (клеток, тканей).

## Содержание
1. [Описание](#описание)
2. [Возможности](#возможности)
3. [Требования](#требования)
4. [Быстрый старт](#быстрый-старт)
5. [Детальное описание](#детальное-описание)
6. [Формат входных данных](#формат-входных-данных)
7. [Результаты](#результаты)
8. [Настройка параметров](#настройка-параметров)
9. [Примеры использования](#примеры-использования)

## Описание

Этот Python-скрипт реализует полный конвейер обработки данных наноиндентации, включая:
- Предварительную обработку данных (сглаживание, коррекция базовой линии)
- Автоматическое определение точки контакта
- Расчет глубины индентации
- Подгонку моделей упругости (Герц, Снеддон)
- Оценку вязкоупругих свойств
- Пакетную обработку нескольких измерений

## Возможности

### Основные функции:
- Автоматическая обработка кривых AFM
- Сглаживание данных фильтром Савицкого-Голея
- Коррекция линейного дрейфа базовой линии
- Определение точки контакта по пороговому методу
- Поддержка двух моделей индентации:
  - **Сферическая модель Герца** (для шарообразных инденторов)
  - **Коническая модель Снеддона** (для пирамидальных инденторов)
- Расчет модуля Юнга и оценка погрешности
- Анализ вязкоупругих свойств через гистерезис

### Дополнительные возможности:
- Автоматическая визуализация результатов (6 графиков на кривую)
- Обработка как единичных файлов, так и папок с данными
- Статистический анализ серии измерений
- Экспорт результатов в CSV формат
- Генерация синтетических данных для тестирования

## Требования

### Необходимые библиотеки:
```bash
numpy >= 1.19.0
pandas >= 1.3.0
matplotlib >= 3.3.0
scipy >= 1.7.0
```

### Установка зависимостей:
```bash
pip install numpy pandas matplotlib scipy
```

## Быстрый старт

### Шаг 1: Клонирование и запуск
```python
# Просто запустите все ячейки в Jupyter Notebook по порядку
# Скрипт автоматически:
# 1. Импортирует необходимые библиотеки
# 2. Определит все функции обработки
# 3. Сгенерирует тестовые синтетические данные
# 4. Проанализирует их и покажет результаты
```

### Шаг 2: Проверка на синтетических данных
После запуска всех ячеек вы увидите:
- 6 графиков с результатами обработки
- Рассчитанный модуль Юнга
- Оценку вязкоупругих свойств
- Сравнение различных моделей

## Детальное описание

### Структура скрипта:

| Ячейка | Назначение | Ключевые функции |
|--------|------------|------------------|
| **1** | Импорт библиотек | - |
| **2** | Определение функций | `smooth_force()`, `correct_baseline()`, `find_contact_point()`, `calculate_indentation()`, `hertz_spherical()`, `fit_hertz_model()` |
| **3** | Генерация синтетических данных | `generate_synthetic_curve()` |
| **4** | Обработка одной кривой | `process_single_curve()` |
| **5** | Обработка файла пользователя | `process_user_file()` |
| **6** | Пакетная обработка | `process_folder()` |
| **7** | Дополнительные утилиты | `export_processed_curve()`, `batch_analysis_config()` |

### Алгоритм обработки:
1. **Сглаживание** → Фильтр Савицкого-Голея для удаления шума
2. **Коррекция базовой линии** → Линейный фит хвостовой части
3. **Определение контакта** → Пороговый метод (5σ шума)
4. **Расчет индентации** → δ = -(z - z₀) - F/k
5. **Подгонка модели** → Нелинейный фит по методу наименьших квадратов
6. **Анализ вязкоупругости** → Расчет площади гистерезиса

## Формат входных данных

### Поддерживаемые форматы:
- Текстовые файлы с разделителями (`.txt`, `.csv`, `.dat`)
- Столбцы с числовыми данными

### Ожидаемая структура данных:
```
# Пример файла данных
Перемещение_мкм    Сила_нН
0.000            0.001
0.001            0.005
0.002            0.012
...
```

### Настройка загрузки:
```python
# Параметры функции load_data()
z_column=0     # Номер столбца с перемещением (Z)
f_column=1     # Номер столбца с силой (F)
skiprows=0     # Количество строк заголовка для пропуска
```

## Результаты

### Для каждой кривой рассчитывается:
| Параметр | Обозначение | Единицы | Описание |
|----------|-------------|---------|----------|
| **E** | Модуль Юнга | Па (Паскаль) | Мера упругости материала |
| **G_loss** | Модуль потерь | Па | Вязкая составляющая |
| **δ_max** | Макс. индентация | м | Максимальная глубина внедрения |
| **z_contact** | Точка контакта | м | Положение первого контакта |
| **R²** | Коэффициент детерминации | - | Качество подгонки модели |
| **A_hyst** | Площадь гистерезиса | - | Энергия рассеяния за цикл |

### Выходные файлы:
- `indentation_results.csv` - сводная таблица по всем файлам
- Экспорт обработанных кривых (опционально)

## Настройка параметров

### Ключевые параметры анализа:

```python
config = {
    'k_cantilever': 0.1,      # Жесткость кантилевера [Н/м]
    'R': 2.5e-6,              # Радиус индентора [м] (для сферической модели)
    'alpha': 18,              # Угол конуса [°] (для конической модели)
    'model_type': 'spherical',# 'spherical' или 'conical'
    'nu': 0.5,                # Коэффициент Пуассона (0.5 для клеток)
    'smoothing_window': 21,   # Окно сглаживания (нечетное число)
    'contact_threshold': 5    # Порог контакта (в σ шума)
}
```

### Рекомендации по выбору параметров:
1. **Жесткость кантилевера** - должна быть калибрована предварительно
2. **Радиус индентора** - указывается производителем
3. **Коэффициент Пуассона** - для большинства клеток используется 0.5
4. **Тип модели** - зависит от геометрии индентора

## Примеры использования

### Пример 1: Обработка одного файла
```python
# Укажите путь к вашему файлу
results = process_user_file(
    filepath="данные/кривая_01.txt",
    k_cantilever=0.1,      # Н/м
    R=2.5e-6,              # м
    z_column=0,            # столбец с перемещением
    f_column=1,            # столбец с силой
    skiprows=1             # пропустить заголовок
)
```

### Пример 2: Пакетная обработка
```python
# Обработка всех файлов в папке
df_results = process_folder(
    folder_path="данные/эксперимент_1/",
    file_pattern="*.txt",      # все текстовые файлы
    k_cantilever=0.1,
    R=2.5e-6,
    save_results=True         # экспорт в CSV
)
```

### Пример 3: Экспорт обработанных данных
```python
# После обработки сохраните кривую
export_processed_curve(
    results, 
    output_file="результаты/обработанная_кривая.csv"
)
```

## Особенности реализации

### Физические модели:
1. **Модель Герца (сферическая)**:
   ```
   F = (4/3) * (E/(1-ν²)) * √R * δ^(3/2)
   ```

2. **Модель Снеддона (коническая)**:
   ```
   F = (2/π) * (E/(1-ν²)) * tan(α) * δ²
   ```

### Методы анализа:
- **Сглаживание**: Фильтр Савицкого-Голея (сохраняет производные)
- **Определение контакта**: Статистический пороговый метод
- **Подгонка кривой**: Метод наименьших квадратов (Levenberg-Marquardt)
- **Оценка ошибок**: Ковариационная матрица фита

## Возможные проблемы и решения

| Проблема | Возможная причина | Решение |
|----------|-------------------|---------|
| Низкое качество фита | Неправильная модель | Проверьте геометрию индентора |
| Отрицательный модуль Юнга | Неверная точка контакта | Увеличьте порог контакта |
| Большой разброс результатов | Шумные данные | Увеличьте окно сглаживания |
| Отсутствие гистерезиса | Слишком упругий образец | Проверьте скорость индентации |

## Интерпретация результатов

### Модуль Юнга (E):
- **10²-10³ Па**: Очень мягкие клетки (эмбриональные)
- **10³-10⁴ Па**: Типичные клетки млекопитающих
- **10⁴-10⁵ Па**: Жесткие клетки (остеобласты, фибробласты)

### Коэффициент потерь (tan δ = G''/G'):
- **< 0.1**: Преимущественно упругое поведение
- **0.1-0.5**: Вязкоупругое поведение
- **> 0.5**: Преимущественно вязкое поведение

## Ссылки и литература

1. Hertz, H. (1882). "On the contact of elastic solids"
2. Sneddon, I.N. (1965). "The relation between load and penetration"

## Лицензия

Этот скрипт распространяется под лицензией MIT. Вы можете свободно использовать, модифицировать и распространять его с указанием авторства.

## Контакты и поддержка

Если у вас возникли вопросы или проблемы с использованием скрипта:
1. Проверьте формат ваших данных
2. Убедитесь в правильности параметров кантилевера
3. Попробуйте обработать синтетические данные для проверки

Для биологических образцов рекомендуется провести не менее 50 измерений на разных клетках для получения статистически значимых результатов.
Написать мне: karina_urazova@icloud.com

---
*Скрипт разработан для анализа механических свойств живых клеток методом AFM наноиндентации.*
